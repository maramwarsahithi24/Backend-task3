const UserModel = require("../models/user");
const bcrypt = require("bcryptjs");
const jwt = require("jsonwebtoken");


async function login(req, res){
    try{
         const {email, password} = req.body;

         const exists = await UserModel.findOne({email});
         if(!exists){
            return res.status(404).json({msg: "User not found"});
        }
        const isSame = await bcrypt.compare(password, exists.password);
        if(!isSame){
            return res.status(401).json({msg: "Invalid password"});
        }
        const token = jwt.sign(
            { id: exists._id },
            "SECRET_KEY",
            { expiresIn: "5h"}
        );
        res.cookie("token",token,{
            httpOnly: true,
            secure: false,
            maxAge: 5*60*60*1000
        });
        return res.status(200).redirect('/notes');
    } catch(error){
        console.log("error:",error);
        return res.status(500).json({msg: "login error"});
    }
}

async function signup(req, res){
    try{
        const {username, email, password} = req.body;
        const exist = await UserModel.findOne({
            $or: [{email},{username}]
        });
        if(exist){
            return res.status(400).json({ msg: "User already exists" });
        }
        const hashpw = await bcrypt.hash(password, 10);
        const newUser = new UserModel({
            username: username,
            email: email,
            password: hashpw
        });
        await newUser.save();
        return res.redirect('/login');
    } catch(error){
        console.log("error:",error);
        return res.status(500).json({msg: "Signup error"});
    }
}

module.exports = {signup, login};
